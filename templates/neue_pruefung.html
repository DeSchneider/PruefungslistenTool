<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<title>Neue Prüfung anlegen</title>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<style>
  body {
    font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    background: #f5f9ff;
    margin: 40px;
  }
  h1 {
    color: #294675;
    margin-bottom: 30px;
  }
  form {
    background: white;
    padding: 30px;
    border-radius: 12px;
    box-shadow: 0 8px 30px rgba(58,71,86,0.18);
    max-width: 600px;
  }
  label {
    display: block;
    margin-top: 15px;
    font-weight: 600;
    color: #37547c;
  }
  input, select {
    margin-top: 6px;
    padding: 10px;
    width: 100%;
    border: 1px solid #cbd6e2;
    border-radius: 6px;
    font-size: 15px;
    transition: border-color 0.2s;
  }
  input:focus, select:focus {
    border-color: #477dda;
    outline: none;
  }
  button {
    margin-top: 25px;
    background: #477dda;
    color: white;
    padding: 14px 40px;
    border: none;
    border-radius: 7px;
    font-size: 18px;
    cursor: pointer;
    transition: background 0.3s;
  }
  button:hover {
    background: #295cd5;
  }
  .favorite-section {
    margin-top: 50px;
    max-width: 600px;
  }
  .favoriten-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
    background: white;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 8px 30px rgba(58,71,86,0.1);
  }
  .favoriten-table th, .favoriten-table td {
    padding: 15px 20px;
    border-bottom: 1px solid #e1e9f0;
    text-align: left;
  }
  .favoriten-table th {
    background: #f0f4fb;
    color: #37547c;
    font-weight: 600;
  }
  .favoriten-table tr:hover {
    background: #f7fafd;
  }
  .lade-favorit-btn {
    padding: 8px 16px;
    background: #294675;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    transition: background 0.3s;
  }
  .lade-favorit-btn:hover {
    background: #1e3550;
  }
  #pruefer_results, #fremdpruefer_results {
    border: 1px solid #ccc;
    max-height: 150px;
    overflow-y: auto;
    display: none;
    position: absolute;
    background: white;
    width: 300px;
    z-index: 1000;
    border-radius: 6px;
  }
</style>
</head>
<body>

<h1>Neue Prüfung anlegen</h1>

<form method="POST" id="pruefungForm" autocomplete="off">
  <label>Ausrichter:
    <input name="ausrichter" type="text" placeholder="z.B. Judo Club Musterstadt" />
  </label>
  <label>Bezirk:
    <input name="bezirk" type="text" placeholder="z.B. Bezirk Nord" />
  </label>
  <label>Ort Straße:
    <input name="ort_strasse" type="text" placeholder="z.B. Musterstraße 10" />
  </label>
  <label>Ort Ort:
    <input name="ort_ort" type="text" placeholder="z.B. Musterstadt" />
  </label>
  <label>Datum:
    <input name="datum" type="date" />
  </label>
  <label>Uhrzeit von:
    <input name="uhrzeit_von" type="time" />
  </label>
  <label>Uhrzeit bis:
    <input name="uhrzeit_bis" type="time" />
  </label>

  <label>Prüfer Name:
    <input name="pruefer_name" id="pruefer_suche_input" />
    <input type="hidden" name="pruefer_id" id="pruefer_id" />
    <div id="pruefer_results"></div>
  </label>

  <label>Fremdprüfer Name:
    <input name="fremdpruefer_name" id="fremdpruefer_suche_input" />
    <input type="hidden" name="fremdpruefer_id" id="fremdpruefer_id" />
    <div id="fremdpruefer_results"></div>
  </label>

  <button type="submit">Prüfung anlegen</button>
</form>

<div class="favorite-section">
  <h2>Gespeicherte Favoriten</h2>
  <form id="favoritSpeichernForm" method="POST" action="{{ url_for('favorit.favorit_speichern') }}">
    <label>Favoritenname (zum Speichern):
      <input name="favorit_name" required placeholder="z.B. Herbstprüfung 2025" />
    </label>
    <button type="submit">Als Favorit speichern</button>

    <!-- versteckte Inputs zur Übertragung -->
    <input type="hidden" name="ausrichter" />
    <input type="hidden" name="bezirk" />
    <input type="hidden" name="ort_strasse" />
    <input type="hidden" name="ort_ort" />
    <input type="hidden" name="datum" />
    <input type="hidden" name="uhrzeit_von" />
    <input type="hidden" name="uhrzeit_bis" />
    <input type="hidden" name="pruefer_id" />
    <input type="hidden" name="fremdpruefer_id" />
  </form>

  <table class="favoriten-table">
    <thead>
      <tr><th>Name</th><th>Ausrichter</th><th>Datum</th><th>Aktion</th></tr>
    </thead>
    <tbody>
      {% for fav in favoriten %}
      <tr>
        <td>{{ fav.name }}</td>
        <td>{{ fav.ausrichter or "" }}</td>
        <td>{{ fav.datum.strftime("%d.%m.%Y") if fav.datum else "" }}</td>
        <td><button class="lade-favorit-btn" data-id="{{ fav.id }}">Übernehmen</button></td>
      </tr>
      {% else %}
      <tr><td colspan="4">Keine Favoriten gespeichert.</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
$(function(){
  function setupPrueferSearch(inputId, resultId, hiddenId) {
    const $input = $(inputId);
    const $results = $(resultId);
    const $hidden = $(hiddenId);

    $input.on("input", function(){
      const val = $input.val();
      if(val.length < 2) {
        $results.hide();
        $hidden.val('');
        return;
      }

      $.getJSON("{{ url_for('pruefung.pruefer_suche') }}", {q: val}, function(data){
        if(data.length === 0){
          $results.html("<div style='padding:5px;'>Keine Treffer</div>").show();
          $hidden.val('');
          return;
        }
        let html = "";
        data.forEach(function(item){
          html += `<div style="padding:5px;cursor:pointer;" data-id="${item.id}" data-name="${item.name}">${item.name} (${item.lizenz_nr})</div>`;
        });
        $results.html(html).show();

        $results.children("div").click(function(){
          $input.val($(this).data("name"));
          $hidden.val($(this).data("id"));
          $results.hide();
        });
      });
    });

    $(document).click(function(e) {
      if (!$(e.target).closest(inputId + ", " + resultId).length) {
        $results.hide();
      }
    });
  }

  setupPrueferSearch("#pruefer_suche_input", "#pruefer_results", "#pruefer_id");
  setupPrueferSearch("#fremdpruefer_suche_input", "#fremdpruefer_results", "#fremdpruefer_id");

  $("#favoritSpeichernForm").on("submit", function(){
    const form = $("#pruefungForm");
    $(this).find("input[name]").each(function(){
      const name = $(this).attr("name");
      if(name === "favorit_name") return;
      const val = form.find(`[name="${name}"]`).val() || '';
      $(this).val(val);
    });
  });

  $(".lade-favorit-btn").click(function(){
    const id = $(this).data("id");
    $.getJSON("{{ url_for('favorit.favorit_laden', favorit_id=0) }}".replace("0", id), function(data){
      const form = $("#pruefungForm");
      form.find('[name="ausrichter"]').val(data.ausrichter || '');
      form.find('[name="bezirk"]').val(data.bezirk || '');
      form.find('[name="ort_strasse"]').val(data.ort_strasse || '');
      form.find('[name="ort_ort"]').val(data.ort_ort || '');
      form.find('[name="datum"]').val(data.datum || '');
      form.find('[name="uhrzeit_von"]').val(data.uhrzeit_von || '');
      form.find('[name="uhrzeit_bis"]').val(data.uhrzeit_bis || '');
      form.find('#pruefer_id').val(data.pruefer_id || '');
      form.find('#fremdpruefer_id').val(data.fremdpruefer_id || '');
      form.find('#pruefer_suche_input').val('');
      form.find('#fremdpruefer_suche_input').val('');
    });
  });
});
</script>

</body>
</html>
